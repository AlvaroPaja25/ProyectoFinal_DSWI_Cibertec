@model IEnumerable<appRestauranteDSW_CoreMVC.Models.Empleado>
@{
    ViewData["Title"] = "Empleados";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
    html, body {
        overflow-x: hidden; /* Evita scroll horizontal global */
    }

    /* Contenedor principal de la tabla */
    .table-container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
        overflow-x: auto;
        padding-bottom: 80px; /* espacio para que no choque con el footer */
    }

    .btn-modern {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-weight: 500;
    }

    .table .btn-sm i {
        margin-right: 0.2rem;
    }

    .filter-icon {
        position: relative;
    }

        .filter-icon input {
            padding-left: 2rem;
        }

        .filter-icon i {
            position: absolute;
            top: 50%;
            left: 0.6rem;
            transform: translateY(-50%);
            color: #495057;
        }

    /* Barra de herramientas alineada */
    .dt-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    /* Ajuste del input de búsqueda */
    .dataTables_filter {
        margin: 0 !important;
    }

        .dataTables_filter label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 500;
        }

    /* Switch moderno */
    .form-check.form-switch {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        margin: 0;
    }
</style>


<div class="container-fluid mt-4 table-container">
    <h1 class="mb-4">Empleados</h1>

    <div class="d-flex align-items-center mb-3 gap-2 flex-wrap">
        <button class="btn btn-success btn-modern" data-bs-toggle="modal" data-bs-target="#empleadoModal" onclick="openCreateModal()">
            <i class="bi bi-plus-lg"></i> Crear Nuevo
        </button>

        <button id="exportExcel" class="btn btn-success btn-modern">
            <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
        </button>

        <button id="toggleFilters" class="btn btn-primary btn-modern">
            <i class="bi bi-funnel"></i> Filtros
        </button>

        <!-- Botón Columnas -->
        <div class="position-relative">
            <button class="btn btn-secondary btn-modern" id="columnToggleBtn">
                <i class="bi bi-layout-three-columns"></i> Columnas
            </button>
            <div id="columnPanel" class="card p-2 shadow position-absolute" style="top:100%; right:0; display:none; z-index:1000;">
                <div class="form-check form-switch">
                    <input class="form-check-input column-switch" type="checkbox" data-column="0" checked>
                    <label class="form-check-label">ID</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input column-switch" type="checkbox" data-column="1" checked>
                    <label class="form-check-label">Nombre</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input column-switch" type="checkbox" data-column="2" checked>
                    <label class="form-check-label">Apellido</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input column-switch" type="checkbox" data-column="3" checked>
                    <label class="form-check-label">DNI</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input column-switch" type="checkbox" data-column="4" checked>
                    <label class="form-check-label">Teléfono</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input column-switch" type="checkbox" data-column="5" checked>
                    <label class="form-check-label">Fecha Registro</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input column-switch" type="checkbox" data-column="6" checked>
                    <label class="form-check-label">Cargo</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input column-switch" type="checkbox" data-column="7" checked>
                    <label class="form-check-label">Usuario</label>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Formulario de filtros elegante -->
    <div id="filterForm" class="card mb-3 p-3" style="display:none;">
        <div class="row g-2">
            <div class="col-md-2 filter-icon">
                <i class="bi bi-hash"></i>
                <input type="text" id="filterID" class="form-control" placeholder="ID" />
            </div>
            <div class="col-md-2 filter-icon">
                <i class="bi bi-person"></i>
                <input type="text" id="filterNombre" class="form-control" placeholder="Nombre" />
            </div>
            <div class="col-md-2 filter-icon">
                <i class="bi bi-person-badge"></i>
                <input type="text" id="filterApellido" class="form-control" placeholder="Apellido" />
            </div>
            <div class="col-md-2 filter-icon">
                <i class="bi bi-credit-card-2-front"></i>
                <input type="text" id="filterDNI" class="form-control" placeholder="DNI" />
            </div>
            <div class="col-md-2 filter-icon">
                <i class="bi bi-telephone"></i>
                <input type="text" id="filterTelefono" class="form-control" placeholder="Teléfono" />
            </div>
            <div class="col-md-2 filter-icon">
                <i class="bi bi-briefcase"></i>
                <input type="text" id="filterCargo" class="form-control" placeholder="Cargo" />
            </div>
        </div>
    </div>

    <table id="empleadosTable" class="table table-bordered table-striped" style="width:100%">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>DNI</th>
                <th>Teléfono</th>
                <th>Fecha Registro</th>
                <th>Cargo</th>
                <th>Usuario</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.id</td>
                    <td>@item.nombre</td>
                    <td>@item.apellido</td>
                    <td>@item.dni</td>
                    <td>@item.telefono</td>
                    <td>@item.fecha_registro.ToShortDateString()</td>
                    <td>@item.cargo?.nombre</td>
                    <td>@item.usuario?.correo</td>
                    <td>
                        <button class="btn btn-warning btn-sm btn-modern" data-bs-toggle="modal" data-bs-target="#empleadoModal" onclick="openEditModal(@item.id)">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-danger btn-sm btn-modern" data-bs-toggle="modal" data-bs-target="#deleteModal" onclick="openDeleteModal(@item.id)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Modales -->
<div class="modal fade" id="empleadoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Empleado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Seguro que deseas eliminar este empleado?</p>
                <form id="deleteForm" method="post">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

<script>
    function openCreateModal() {
        fetch('/Empleados/Create')
            .then(res => res.text())
            .then(html => {
                document.getElementById('modalBody').innerHTML = html;
                document.getElementById('modalTitle').innerText = 'Crear Empleado';
            });
    }

    function openEditModal(id) {
        fetch('/Empleados/Edit/' + id)
            .then(res => res.text())
            .then(html => {
                document.getElementById('modalBody').innerHTML = html;
                document.getElementById('modalTitle').innerText = 'Editar Empleado';
            });
    }

    function openDeleteModal(id) {
        document.getElementById('deleteForm').action = '/Empleados/Delete/' + id;
    }

      $(document).ready(function() {
        var table = $('#empleadosTable').DataTable({
            ordering: false,
            dom: '<"dt-toolbar"<"d-flex gap-2"Bf>>tip',
            buttons: [],
            scrollX: false,
            autoWidth: false,
            language: {
                search: "Buscar:"
            }
        });

        // Mostrar/ocultar panel de columnas
        $('#columnToggleBtn').click(function() {
            $('#columnPanel').toggle();
        });

        // Cambiar visibilidad de cada columna según el switch
        $('.column-switch').on('change', function() {
            var columnIndex = $(this).data('column');
            var isChecked = $(this).is(':checked');
            table.column(columnIndex).visible(isChecked);
        });

        // filtros
        $('#filterID').on('keyup change', function(){ table.column(0).search(this.value).draw(); });
        $('#filterNombre').on('keyup change', function(){ table.column(1).search(this.value).draw(); });
        $('#filterApellido').on('keyup change', function(){ table.column(2).search(this.value).draw(); });
        $('#filterDNI').on('keyup change', function(){ table.column(3).search(this.value).draw(); });
        $('#filterTelefono').on('keyup change', function(){ table.column(4).search(this.value).draw(); });
        $('#filterCargo').on('keyup change', function(){ table.column(6).search(this.value).draw(); });

        $('#exportExcel').on('click', function() {
            table.button('.buttons-excel').trigger();
        });

        $('#toggleFilters').click(function() {
            $('#filterForm').slideToggle();
        });

        // Cerrar panel si clic fuera
        $(document).on('click', function(event) {
            if (!$(event.target).closest('#columnToggleBtn, #columnPanel').length) {
                $('#columnPanel').hide();
            }
        });
    });

</script>
